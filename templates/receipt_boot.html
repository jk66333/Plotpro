<!-- templates/receipt_boot.html -->
<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Receipt</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- User CSS -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">

  <style>
    :root {
      --brand: #f16924;
      --muted: #6b6b6b;
      --gap-between-panels: 10mm;
      --panel-border: 1px solid #d1d1d1;
      --panel-radius: 6px;
      --panel-pad-h: 8px;
      --panel-pad-v: 8px;
    }

    *,
    *:before,
    *:after {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: Helvetica, Arial, sans-serif;
      color: #222;
      background: #fff;
    }

    @page {
      size: A4;
      margin: 12mm;
    }

    .print-area {
      width: calc(210mm - 24mm - 0.4mm);
      margin: 0 auto;
      box-sizing: border-box;
    }

    .two-up {
      display: grid;
      grid-template-rows: auto auto;
      row-gap: var(--gap-between-panels);
    }

    .receipt-panel {
      width: 100%;
      height: calc((297mm - 24mm - var(--gap-between-panels)) / 2 + 4mm);
      padding: var(--panel-pad-v) var(--panel-pad-h);
      border: var(--panel-border);
      border-radius: var(--panel-radius);
      display: flex;
      flex-direction: column;
      background: #fff;
      -webkit-print-color-adjust: exact;
      page-break-inside: avoid;
      break-inside: avoid;
      overflow: hidden;
      position: relative;
    }

    .receipt-header {
      display: flex;
      align-items: center;
      gap: 8px;
      padding-bottom: 6px;
    }

    .receipt-logo {
      height: 34px;
      object-fit: contain;
      display: block;
    }

    .company-address {
      color: var(--muted);
      font-size: 11px;
      margin-left: 6px;
    }

    .receipt-title {
      margin-left: auto;
      text-align: right;
    }

    .receipt-title .title {
      color: var(--brand);
      font-weight: 700;
      font-size: 18px;
    }

    .receipt-title .copy {
      font-size: 11px;
      color: var(--muted);
      margin-top: 4px;
    }

    .divider {
      height: 1px;
      background: #eee;
      border: none;
      margin: 6px 0 8px;
    }

    .receipt-body {
      flex: 1 1 auto;
      display: flex;
      flex-direction: column;
      min-height: 0;
    }

    .fields {
      flex: 0 1 auto;
    }

    .bottom-area {
      flex: 0 1 auto;
    }

    .row-field {
      display: flex;
      gap: 10px;
      margin-bottom: 6px;
    }

    .col-field {
      flex: 1;
      min-width: 0;
    }

    .col-field label {
      display: block;
      font-size: 11px;
      color: var(--muted);
      margin-bottom: 3px;
    }

    .col-field .value {
      font-weight: 700;
      font-size: 13px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .col-field.customer .value {
      font-size: 15px;
      font-weight: 800;
    }

    .amount-value {
      font-weight: 800;
      color: var(--brand);
      font-size: 16px;
    }

    .words-box {
      margin-top: 6px;
    }

    .words-title {
      color: var(--muted);
      font-size: 11px;
      margin-bottom: 4px;
    }

    .words-text {
      font-style: italic;
      font-weight: 600;
    }

    .signature-wrap {
      margin-top: auto;
      display: flex;
      justify-content: space-between;
      gap: 12px;
      align-items: flex-end;
      padding-top: 6px;
      padding-bottom: 6px;
    }

    .sig-block {
      width: 33%;
      text-align: center;
      padding: 0 6px;
    }

    .sig-line {
      border-top: 1px solid #999;
      margin-bottom: 6px;
    }

    .sig-label {
      font-size: 11px;
      color: var(--muted);
    }

    .action-btn {
      background: var(--brand) !important;
      border-color: var(--brand) !important;
      color: #fff !important;
    }

    .action-btn:hover {
      background: #d85e1f !important;
    }

    {% if pdf_mode %}
    .actions {
      display: none !important;
    }
    {% endif %}

    @media print {
      .two-up {
        page-break-after: avoid;
        break-after: avoid;
      }

      .receipt-panel {
        page-break-inside: avoid;
        break-inside: avoid;
      }
    }
  </style>
</head>

<body>

  <!-- FLASH MESSAGES (Screen only) -->
  <style>
    @media print {
      .flash-wrap {
        display: none !important;
      }
    }

    .flash-wrap {
      max-width: 800px;
      /* Fits nicely above A4 width */
      margin: 14px auto 0;
      padding: 0 16px;
    }
  </style>
  <div class="flash-wrap">
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    {% for category, message in messages %}
    <div
      class="alert alert-{{ 'danger' if category == 'danger' else (category or 'info') }} alert-dismissible fade show"
      role="alert">
      {{ message }}
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endfor %}
    {% endif %}
    {% endwith %}
  </div>

  <div class="print-area">
    <div class="two-up">

      {% for copy_label in ["Customer Copy","Office Copy"] %}
      <section class="receipt-panel">

        <header class="receipt-header">
          {% if r.get('logo_data') %}
          <img class="receipt-logo" src="{{ r.logo_data }}" alt="Logo">
          {% else %}
          <img class="receipt-logo" src="{{ url_for('static', filename='images/logo.png') }}" alt="Logo">
          {% endif %}
          <div class="company-address">Opp. Sri Ram Hospitals, Pushpa Hotel Road, Vijayawada</div>

          <div class="receipt-title">
            <div class="title">RECEIPT</div>
            <div class="copy">{{ copy_label }}</div>
          </div>
        </header>

        <div class="divider"></div>

        <div class="receipt-body">

          <div class="fields">
            <div class="row-field">
              <div class="col-field"><label>No</label>
                <div class="value">{{ r.no }}</div>
              </div>
              <div class="col-field"><label>Date</label>
                <div class="value">{{ r.date }}</div>
              </div>
            </div>

            <div class="row-field">
              <div class="col-field"><label>Project</label>
                <div class="value">{{ r.project_name }}</div>
              </div>
              <div class="col-field"><label>Venture</label>
                <div class="value">{{ r.venture }}</div>
              </div>
            </div>

            <div class="row-field">
              <div class="col-field customer"><label>Customer</label>
                <div class="value">{{ r.customer_name }}</div>
              </div>
              <div class="col-field"><label>Payment Mode</label>
                <div class="value">{{ r.payment_mode }}</div>
              </div>
            </div>

            <!-- Instrument / UTR / Cheque row: shown only when instrument_no exists -->
            {% if r.instrument_no %}
            <div class="row-field">
              <div class="col-field">
                {% if r.payment_mode and r.payment_mode.lower() == 'cheque' %}
                <label>Cheque No</label>
                {% elif r.payment_mode and ('online' in r.payment_mode.lower() or 'transfer' in r.payment_mode.lower())
                %}
                <label>UTR / Transaction ID</label>
                {% else %}
                <label>Instrument No</label>
                {% endif %}
                <div class="value">{{ r.instrument_no }}</div>
              </div>
              <div class="col-field"><label>Drawn Bank</label>
                <div class="value">{{ r.drawn_bank or '-' }}</div>
              </div>
            </div>
            {% else %}
            <div class="row-field">
              <div class="col-field"><label>Drawn Bank</label>
                <div class="value">{{ r.drawn_bank or '-' }}</div>
              </div>
              <div class="col-field"><label>Branch</label>
                <div class="value">{{ r.branch or '-' }}</div>
              </div>
            </div>
            {% endif %}

            <div class="row-field">
              <div class="col-field"><label>Plot No</label>
                <div class="value">{{ r.plot_no }}</div>
              </div>
              <div class="col-field"><label>Sq.Yds</label>
                <div class="value">{{ r.square_yards }}</div>
              </div>
            </div>

            <div class="row-field">
              <div class="col-field"><label>Purpose</label>
                <div class="value">{{ r.purpose }}</div>
              </div>
            </div>
          </div>

          <div class="bottom-area">
            <div class="row-field" style="margin-top:6px;">
              <div style="flex:1"></div>
              <div class="col-field" style="flex:0 0 40%;">
                <label>Amount</label>
                <div class="amount-value">Rs. {{ r.amount_formatted }}</div>
              </div>
            </div>

            <div class="row-field" style="margin-top:6px;">
              <div class="col-field">
                <div class="words-box">
                  <div class="words-title">Amount (in words)</div>
                  <div class="words-text">{{ r.amount_words }}</div>
                </div>
              </div>
            </div>
          </div>

          <div class="signature-wrap">
            <div class="sig-block">
              <div class="sig-line"></div>
              <div class="sig-label">Cashier</div>
            </div>
            <div class="sig-block">
              <div class="sig-line"></div>
              <div class="sig-label">Accountant</div>
            </div>
            <div class="sig-block">
              <div class="sig-line"></div>
              <div class="sig-label">Authorised Signature</div>
            </div>
          </div>

        </div>

      </section>
      {% endfor %}

    </div>
  </div>

  {% if not pdf_mode %}
  <div class="actions text-center mt-4 mb-4" style="padding:12px;">

    {% if session.get('role') == 'admin' %}
    <!-- DASHBOARD BUTTON -->
    <a class="btn btn-lg action-btn me-3" href="{{ url_for('dashboard') }}">
      Dashboard
    </a>
    {% endif %}

    <!-- BACK BUTTON -->
    <a class="btn btn-lg action-btn me-3" href="{{ url_for('index') }}">
      ‚Üê Back
    </a>

    <!-- EDIT BUTTON -->
    <a class="btn btn-lg action-btn me-3" href="{{ url_for('edit_receipt', receipt_id=r.id) }}">
      Edit
    </a>

    <!-- PENDING RECEIPTS BUTTON -->
    <a class="btn btn-lg action-btn me-3" href="{{ url_for('pending_receipts') }}">
      Pending
    </a>

    <!-- PREVIEW BUTTON -->
    <a class="btn btn-lg action-btn me-3" href="{{ url_for('receipt_view_html', receipt_id=r.id) }}">
      Preview
    </a>

    <!-- BUTTON (JS downloader) -->
    <button id="downloadPdfBtn" class="btn btn-lg action-btn" type="button"
      data-pdf-url="{{ url_for('receipt_pdf', receipt_id=r.id) }}"
      data-default-filename="receipt_{{ (r.no or r.id)|replace(' ', '_') }}.pdf">
      Download PDF
    </button>

  </div>
  {% endif %}

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // Robust client-side PDF downloader that preserves filename.
    (function () {
      const btn = document.getElementById('downloadPdfBtn');
      if (!btn) return;

      // sanitize filename fragment (allow only safe chars)
      function sanitizeFilename(name, fallback) {
        if (!name) return fallback || 'receipt';
        // replace sequences of unsafe chars with underscore
        const safe = name.replace(/[^A-Za-z0-9._-]+/g, '_').replace(/^_+|_+$/g, '');
        return safe || (fallback || 'receipt');
      }

      // parse filename from Content-Disposition header if present
      function filenameFromContentDisposition(header) {
        if (!header) return null;
        // attempt RFC5987 first
        const filenameStar = /filename\*\s*=\s*([^;]+)/i.exec(header);
        if (filenameStar) {
          // format: filename*=UTF-8''encoded-filename
          try {
            const part = filenameStar[1].trim();
            const m = part.match(/^(?:[A-Za-z0-9_-]+)''(.+)$/);
            if (m && m[1]) {
              return decodeURIComponent(m[1]);
            }
            return part.replace(/(^"|"$)/g, '');
          } catch (e) {
            // ignore
          }
        }
        // fallback to filename="..."
        const filenameMatch = /filename\s*=\s*"(.*?)"/i.exec(header) || /filename\s*=\s*([^;]+)/i.exec(header);
        if (filenameMatch) {
          return filenameMatch[1].replace(/^"|"$/g, '').trim();
        }
        return null;
      }

      btn.addEventListener('click', async function () {
        const url = btn.getAttribute('data-pdf-url');
        if (!url) {
          alert('No PDF URL configured.');
          return;
        }
        btn.disabled = true;
        const defaultName = btn.getAttribute('data-default-filename') || 'receipt.pdf';
        try {
          const resp = await fetch(url, {
            method: 'GET',
            headers: {
              'Accept': 'application/pdf'
            },
            credentials: 'same-origin'
          });

          if (!resp.ok) {
            const txt = await resp.text().catch(() => null);
            throw new Error('Server returned ' + resp.status + (txt ? (': ' + txt) : ''));
          }

          const blob = await resp.blob();

          // Try to get filename from header
          const cd = resp.headers.get('Content-Disposition');
          let filename = filenameFromContentDisposition(cd);

          if (!filename) {
            // fallback to server-provided default (from template)
            filename = defaultName;
          }

          filename = sanitizeFilename(filename, 'receipt.pdf');

          // Create temporary download link
          const blobUrl = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = blobUrl;
          a.download = filename;
          // For browsers that require it: append to DOM, click, remove
          document.body.appendChild(a);
          a.click();
          a.remove();
          // cleanup
          setTimeout(() => URL.revokeObjectURL(blobUrl), 2000);
        } catch (err) {
          console.error('PDF download error', err);
          alert('Failed to download PDF: ' + (err.message || err));
        } finally {
          btn.disabled = false;
        }
      });
    })();
  </script>

</body>

</html>