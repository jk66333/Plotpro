{% extends "base.html" %}
{% block content %}

<style>
  :root {
    --brand-primary: #f16924;
    --brand-secondary: #d85e1f;
  }

  .page-wrapper {
    background: linear-gradient(to bottom, #f8f9fa 0%, #e9ecef 100%);
    min-height: 100vh;
    padding: 2rem 0;
  }

  .search-container {
    max-width: 900px;
    margin: 0 auto;
  }

  .page-header {
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    padding: 2rem;
    margin-bottom: 2rem;
    text-align: center;
  }

  .page-title {
    font-size: 2rem;
    font-weight: 700;
    color: #212529;
    margin-bottom: 0;
  }

  .search-form {
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    padding: 2rem;
    margin-bottom: 2rem;
  }

  .search-row {
    display: flex;
    gap: 1rem;
    align-items: end;
  }

  .form-control,
  .form-select {
    border: 2px solid #dee2e6;
    border-radius: 8px;
    padding: 0.75rem 1rem;
    font-weight: 500;
    transition: all 0.3s;
  }

  .form-control:focus,
  .form-select:focus {
    border-color: var(--brand-primary);
    box-shadow: 0 0 0 0.2rem rgba(241, 105, 36, 0.15);
  }

  .btn-search {
    background: var(--brand-primary);
    color: white;
    border: none;
    padding: 0.75rem 2rem;
    border-radius: 8px;
    font-weight: 600;
    transition: all 0.3s;
  }

  .btn-search:hover {
    background: var(--brand-secondary);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(241, 105, 36, 0.3);
  }

  .btn-back {
    background: #6c757d;
    color: white;
    border: none;
    padding: 0.75rem 1.5rem;
    border-radius: 8px;
    font-weight: 600;
    text-decoration: none;
    display: inline-block;
    transition: all 0.3s;
  }

  .btn-back:hover {
    background: #5a6268;
    color: white;
    transform: translateY(-2px);
  }

  .results-container {
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    padding: 2rem;
  }

  .table {
    margin-bottom: 0;
  }

  .table thead th {
    background: #f8f9fa;
    font-weight: 700;
    color: #495057;
    border-bottom: 2px solid #dee2e6;
    padding: 1rem;
  }

  .table tbody td {
    padding: 1rem;
    vertical-align: middle;
  }

  .btn-open {
    background: var(--brand-primary);
    color: white;
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 6px;
    font-weight: 600;
    font-size: 0.875rem;
    text-decoration: none;
    display: inline-block;
    transition: all 0.3s;
  }

  .btn-open:hover {
    background: var(--brand-secondary);
    color: white;
    transform: translateY(-2px);
  }

  .no-results {
    text-align: center;
    padding: 3rem;
    color: #6c757d;
  }

  .no-results-icon {
    font-size: 3rem;
    color: #dee2e6;
    margin-bottom: 1rem;
  }

  @media (max-width: 768px) {
    .search-row {
      flex-direction: column;
    }

    .search-row>* {
      width: 100%;
    }

    .page-title {
      font-size: 1.5rem;
    }

    .table {
      font-size: 0.875rem;
    }
  }
</style>

<div class="page-wrapper">
  <div class="container search-container">

    <!-- Page Header -->
    <div class="page-header">
      <h1 class="page-title">Search Receipts by Plot Number</h1>
    </div>

    <!-- Search Form -->
    <div class="search-form">
      <form method="POST" autocomplete="off">
        <div class="search-row">
          <div class="flex-grow-1">
            <label for="plotNo" class="form-label fw-semibold">Plot Number</label>
            <input type="text" name="plot_no" id="plotNo" value="{{ plot_no or '' }}" class="form-control"
              placeholder="Enter plot number (e.g. 558)" required autocomplete="off">
          </div>

          <div style="min-width: 200px;">
            <label for="projectName" class="form-label fw-semibold">Project</label>
            <select name="project_name" id="projectName" class="form-select">
              <option value="">All Projects</option>
              {% for p in projects %}
              <option value="{{ p }}" {% if selected_project==p %}selected{% endif %}>{{ p }}</option>
              {% endfor %}
            </select>
          </div>

          <button class="btn-search" type="submit">
            <i class="bi bi-search me-2"></i>Search
          </button>

          <a href="{{ url_for('index') }}" class="btn-back">
            <i class="bi bi-arrow-left me-2"></i>Back
          </a>
        </div>
      </form>
    </div>

    <!-- Results -->
    {% if results %}
    <div class="results-container">
      <div class="table-responsive">
        <table class="table table-hover">
          <thead>
            <tr>
              <th>Receipt No</th>
              <th>Customer</th>
              <th>Payment Mode</th>
              <th>Date</th>
              <th class="text-end">Amount</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            {% for row in results %}
            <tr id="row-{{ row.id }}">
              <td class="font-monospace">{{ row.no or row.id }}</td>
              <td>{{ row.customer_name or '-' }}</td>
              <td>{{ row.payment_mode or '-' }}</td>
              <td>{{ row.date or '-' }}</td>
              <td class="text-end fw-bold">â‚¹{{ row.amount_formatted or '-' }}</td>
              <td>
                <div class="d-flex gap-2">
                  <a class="btn-open" href="{{ url_for('view_receipt', receipt_id=row.id) }}">
                    Open
                  </a>
                  {% if session.get('role') == 'admin' %}
                  <button class="btn btn-sm btn-outline-danger" onclick="deleteReceiptSearch({{ row.id }})">
                    <i class="bi bi-trash"></i>
                  </button>
                  {% endif %}
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
    {% elif plot_no %}
    <div class="results-container">
      <div class="no-results">
        <div class="no-results-icon">
          <i class="bi bi-inbox"></i>
        </div>
        <p class="fs-5">No receipts found for plot number <strong>{{ plot_no }}</strong></p>
      </div>
    </div>
    {% endif %}

  </div>
</div>

<script>
  function deleteReceiptSearch(receiptId) {
    if (!confirm("Are you sure you want to delete this receipt? This action cannot be undone.")) {
      return;
    }

    fetch(`/receipt/${receiptId}/delete`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      }
    })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          alert("Receipt deleted successfully.");
          // Remove row from DOM
          const row = document.getElementById(`row-${receiptId}`);
          if (row) {
            row.remove();
          }
        } else {
          alert("Error: " + (data.error || "Unknown error"));
        }
      })
      .catch(err => {
        console.error(err);
        alert("An error occurred while deleting.");
      });
  }
</script>

{% endblock %}